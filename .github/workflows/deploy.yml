name: ðŸš€ Deploy Odoo 18 to Google Cloud

on:
  repository_dispatch:
    types: [deploy-odoo]
  workflow_dispatch:  # âœ… Permite ejecuciÃ³n manual
    inputs:
      instance_name:
        description: 'Nombre base para la instancia'
        required: false
        default: 'odoo'
      machine_type:
        description: 'Tipo de mÃ¡quina'
        required: false
        default: 'e2-medium'
        type: choice
        options:
        - e2-micro
        - e2-small
        - e2-medium
        - e2-standard-2
        - e2-standard-4
      zone:
        description: 'Zona de GCP'
        required: false
        default: 'southamerica-west1-a'
        type: choice
        options:
        - southamerica-west1-a
        - southamerica-east1-a
        - us-central1-a
        - us-east1-a
        - europe-west1-a
      disk_size:
        description: 'TamaÃ±o del disco en GB'
        required: false
        default: '20'
        type: choice
        options:
        - '20'
        - '30'
        - '50'
        - '100'
      wait_for_installation:
        description: 'Esperar hasta que la instalaciÃ³n complete'
        required: false
        default: true
        type: boolean

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Timeout mÃ¡s largo para la instalaciÃ³n completa
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: â˜ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: ðŸ·ï¸ Generate instance name
      id: generate_name
      run: |
        # Obtener parÃ¡metros desde diferentes fuentes
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          BASE_NAME="${{ github.event.inputs.instance_name || 'odoo' }}"
        else
          BASE_NAME="${{ github.event.client_payload.instance_name || 'odoo' }}"
        fi
        
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        INSTANCE_NAME="${BASE_NAME}-${TIMESTAMP}"
        
        # Validar nombre de instancia (solo letras minÃºsculas, nÃºmeros y guiones)
        if [[ ! $INSTANCE_NAME =~ ^[a-z0-9-]+$ ]]; then
          echo "âŒ Error: El nombre de la instancia solo puede contener letras minÃºsculas, nÃºmeros y guiones"
          exit 1
        fi
        
        echo "INSTANCE_NAME=$INSTANCE_NAME" >> $GITHUB_OUTPUT
        echo "BASE_NAME=$BASE_NAME" >> $GITHUB_OUTPUT
        echo "ðŸ—ï¸ Nombre de instancia generado: $INSTANCE_NAME"

    - name: ðŸ–¥ï¸ Create VM Instance
      run: |
        INSTANCE_NAME="${{ steps.generate_name.outputs.INSTANCE_NAME }}"
        
        # Obtener parÃ¡metros segÃºn el tipo de evento
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          MACHINE_TYPE="${{ github.event.inputs.machine_type || 'e2-medium' }}"
          ZONE="${{ github.event.inputs.zone || 'southamerica-west1-a' }}"
          DISK_SIZE="${{ github.event.inputs.disk_size || '20' }}"
        else
          MACHINE_TYPE="${{ github.event.client_payload.machine_type || 'e2-medium' }}"
          ZONE="${{ github.event.client_payload.zone || 'southamerica-west1-a' }}"
          DISK_SIZE="${{ github.event.client_payload.disk_size || '20' }}"
        fi
        
        echo "ðŸ—ï¸ Creando instancia: $INSTANCE_NAME"
        echo "ðŸ–¥ï¸ Tipo de mÃ¡quina: $MACHINE_TYPE"
        echo "ðŸŒ Zona: $ZONE"
        echo "ðŸ’¾ TamaÃ±o del disco: ${DISK_SIZE}GB"
        
        gcloud compute instances create $INSTANCE_NAME \
          --project=${{ env.PROJECT_ID }} \
          --zone=$ZONE \
          --machine-type=$MACHINE_TYPE \
          --network-interface=network-tier=PREMIUM,stack-type=IPV4_ONLY,subnet=default \
          --maintenance-policy=MIGRATE \
          --provisioning-model=STANDARD \
          --service-account=${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }} \
          --scopes=https://www.googleapis.com/auth/devstorage.read_only,https://www.googleapis.com/auth/logging.write,https://www.googleapis.com/auth/monitoring.write,https://www.googleapis.com/auth/servicecontrol,https://www.googleapis.com/auth/service.management.readonly,https://www.googleapis.com/auth/trace.append \
          --tags=odoo-server,http-server,https-server \
          --image-family=ubuntu-2204-lts \
          --image-project=ubuntu-os-cloud \
          --boot-disk-size=$DISK_SIZE \
          --boot-disk-type=pd-balanced \
          --boot-disk-device-name=$INSTANCE_NAME \
          --no-shielded-secure-boot \
          --shielded-vtpm \
          --shielded-integrity-monitoring \
          --labels=environment=production,application=odoo,created-by=github-actions \
          --reservation-affinity=any \
          --metadata-from-file=startup-script=./startup-script.sh \
          --metadata=instance-name=$INSTANCE_NAME,deployment-time=$(date -u +"%Y-%m-%dT%H:%M:%SZ"),github-actor=${{ github.actor }},ssh-keys="${{ secrets.GCP_SSH_USER }}:${{ secrets.GCP_SSH_PUBLIC_KEY }}"
        
        echo "INSTANCE_NAME=$INSTANCE_NAME" >> $GITHUB_ENV
        echo "ZONE=$ZONE" >> $GITHUB_ENV

    - name: â³ Wait for instance to be ready
      run: |
        INSTANCE_NAME="${{ steps.generate_name.outputs.INSTANCE_NAME }}"
        
        # Obtener zona segÃºn el tipo de evento
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ZONE="${{ github.event.inputs.zone || 'southamerica-west1-a' }}"
        else
          ZONE="${{ github.event.client_payload.zone || 'southamerica-west1-a' }}"
        fi
        
        echo "â³ Esperando que la instancia estÃ© lista..."
        
        # Esperar hasta que la instancia estÃ© corriendo
        for i in {1..30}; do
          STATUS=$(gcloud compute instances describe $INSTANCE_NAME --zone=$ZONE --format="get(status)")
          if [ "$STATUS" = "RUNNING" ]; then
            echo "âœ… Instancia estÃ¡ corriendo"
            break
          fi
          echo "â³ Esperando... ($i/30) Estado actual: $STATUS"
          sleep 10
        done
        
        # Esperar que SSH estÃ© disponible
        echo "â³ Verificando disponibilidad de SSH..."
        for i in {1..20}; do
          if gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --command="echo 'SSH disponible'" --ssh-flag="-o ConnectTimeout=5" &>/dev/null; then
            echo "âœ… SSH estÃ¡ disponible"
            break
          fi
          echo "â³ Esperando SSH... ($i/20)"
          sleep 15
        done

    - name: âš™ï¸ Configurar Nginx + Certbot + WebSocket
      run: |
        INSTANCE_NAME="${{ steps.generate_name.outputs.INSTANCE_NAME }}"
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ZONE="${{ github.event.inputs.zone || 'southamerica-west1-a' }}"
        else
          ZONE="${{ github.event.client_payload.zone || 'southamerica-west1-a' }}"
        fi
        
        # Crear script temporal con las variables
        cat > configure_nginx.sh << 'SCRIPT_EOF'

        DOMAIN="${{ secrets.ODDO_DOMAIN }}"
        EMAIL="${{ secrets.SSL_EMAIL }}"

        echo "ðŸ”§ Instalando Nginx y Certbot"
        sudo apt update && sudo apt install -y nginx certbot python3-certbot-nginx

        echo "ðŸ”§ Configurando Nginx para Odoo + WebSocket"
        sudo tee /etc/nginx/sites-available/odoo <<EOF
        server {
          listen 80;
          server_name $DOMAIN;
          return 301 https://\$host\$request_uri;
        }

        server {
        listen 443 ssl;
        server_name $DOMAIN;

        ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;

        location / {
          proxy_pass http://localhost:8069;
          proxy_set_header Host \$host;
          proxy_set_header X-Real-IP \$remote_addr;
          proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto \$scheme;
        }

        location /wss/ {
          proxy_pass http://localhost:8072;
          proxy_http_version 1.1;
          proxy_set_header Upgrade \$http_upgrade;
          proxy_set_header Connection "Upgrade";
          proxy_set_header Host \$host;
        }
        }
        EOF

        echo "ðŸ”§ Activando configuraciÃ³n de Nginx"
        sudo ln -sf /etc/nginx/sites-available/odoo /etc/nginx/sites-enabled/odoo
        sudo nginx -t && sudo systemctl reload nginx

        echo "ðŸ” Solicitando certificado SSL con Certbot para dominio: $DOMAIN" 
        if [ -n "$DOMAIN" ] && [ -n "$EMAIL" ]; then
          sudo certbot --nginx -d "$DOMAIN" --agree-tos --email "$EMAIL" --non-interactive --redirect
        else
          echo "âŒ Error: DOMAIN o EMAIL no estÃ¡n definidos"
          echo "DOMAIN: $DOMAIN"
          echo "EMAIL: $EMAIL"
        fi
        SCRIPT_EOF

        # Copiar y ejecutar el script en la instancia
        gcloud compute scp configure_nginx.sh $INSTANCE_NAME:/tmp/ --zone=$ZONE
        gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --command="chmod +x /tmp/configure_nginx.sh && /tmp/configure_nginx.sh"
        script: |
          DOMAIN=${{ secrets.ODDO_DOMAIN }}
          EMAIL=${{ secrets.SSL_EMAIL }}

          echo "ðŸ”§ Instalando Nginx y Certbot"
          sudo apt update && sudo apt install -y nginx certbot python3-certbot-nginx

          echo "ðŸ”§ Configurando Nginx para Odoo + WebSocket"
          sudo tee /etc/nginx/sites-available/odoo <<EOF
          server {
              listen 80;
              server_name $DOMAIN;
              #return 301 https://\$host\$request_uri;
              return 301 http://\$host\$request_uri;
          }

          server {
              listen 443 ssl;
              server_name $DOMAIN;

              ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;

              location / {
                  proxy_pass http://localhost:8069;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
              }

              location /wss/ {
                  proxy_pass http://localhost:8072;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection "Upgrade";
                  proxy_set_header Host \$host;
              }
          }
          EOF

          echo "ðŸ”§ Activando configuraciÃ³n de Nginx"
          sudo ln -sf /etc/nginx/sites-available/odoo /etc/nginx/sites-enabled/odoo
          sudo nginx -t && sudo systemctl reload nginx

          echo "ðŸ” Solicitando certificado SSL con Certbot"
          sudo certbot --nginx -d $DOMAIN --agree-tos --email $EMAIL --non-interactive --redirect

    - name: ðŸ”¥ Create firewall rules
      run: |
        # Regla para Odoo (puerto 8069)
        gcloud compute firewall-rules create allow-odoo \
          --project=${{ env.PROJECT_ID }} \
          --direction=INGRESS \
          --priority=1000 \
          --network=default \
          --action=ALLOW \
          --rules=tcp:8069 \
          --source-ranges=0.0.0.0/0 \
          --target-tags=odoo-server \
          --description="Allow Odoo access on port 8069" || echo "Firewall rule already exists"
        
        # Regla para SSH (si no existe)
        gcloud compute firewall-rules create allow-ssh \
          --project=${{ env.PROJECT_ID }} \
          --direction=INGRESS \
          --priority=1000 \
          --network=default \
          --action=ALLOW \
          --rules=tcp:22 \
          --source-ranges=0.0.0.0/0 \
          --target-tags=odoo-server \
          --description="Allow SSH access" || echo "SSH firewall rule already exists"

        # Reglas para WebSocket (puertos 8765 y 8766)
        gcloud compute firewall-rules create allow-websocket \
          --project=${{ env.PROJECT_ID }} \
          --direction=INGRESS \
          --priority=1000 \
          --network=default \
          --action=ALLOW \
          --rules=tcp:8765,tcp:8766 \
          --source-ranges=0.0.0.0/0 \
          --target-tags=odoo-server || echo "WebSocket firewall rule already exists"
